# (**************************************************************************************************************)
#
# This is a complete template for a MAESTRO simulation
#
# (**************************************************************************************************************)

# ------------------------------------------------------------------------------------------------------------
# Plasma
# ------------------------------------------------------------------------------------------------------------

# Name of this simulation
flag: SPARC PRD

# Master random seed for reproducibility, to be sent to all beats that can receive seed
seed: 0

# Machine parameters
machine:

  # Engineering parameters
  Bt: 12.2
  Ip: 8.7

  # Separatrix specification
  separatrix:
    type: freegs
    parameters:
      R: 1.85
      a: 0.57
      delta_sep: 0.57
      kappa_sep: 1.97
      n_mxh: 5
      geqdsk_file: ""

  # Heating parameters
  heating:
    type: ICRH
    parameters:
      P_icrh: 11.0
      minority: [2, 3]
      fmini: 0.05

# Simulation assumptions
assumptions:

  # Impurities
  Zeff: 1.5
  mix:
    fmain: 0.85
    ZW: 50
    fW: 1.5e-5

  # Initialization of profiles
  initialization:

    # neped as the input (engineering) parameter
    assume_neped: true
    neped_20: 2.5

    # ne_sep / ne_ped ratio to assume (e.g. for EPED) and construct profiles with
    nesep_ratio: 0.3
    
    # Profiles will be initialize such that these parameters are matched as close as possible
    BetaN: 1.0
    density_peaking: 1.3
    
  # Edge parameters
  Tesep_eV: 75.0

# ------------------------------------------------------------------------------------------------------------
# MAESTRO workflow parameters
# ------------------------------------------------------------------------------------------------------------

maestro:

  # Remove intermediate files
  keep_all_files: true

  # Sequence of beats
  beats: ["transp_soft", "transp", "eped", "portals", "eped", "portals"]

  # ---------------------------------------------------------------------------
  # Each individual beat parameters
  # ---------------------------------------------------------------------------

  eped_beat:
    use_default: false
    eped_namelist:
      nn_location: $MFEIM_PATH/private_code_mitim/NN_DATA/EPED-NN-SPARC/EPED-NN-MODEL-SPARC.keras
      norm_location: $MFEIM_PATH/private_code_mitim/NN_DATA/EPED-NN-SPARC/EPED-NN-NORMALIZATION-SPARC.txt

      # Corrections set for EPED indicate the values that I force them to be exact, to avoid NN issues with non-trained parameters
      corrections_set:
        Bt: 12.2
        R: 1.85
        a: 0.57

      # Operations after EPED pressure predictions
      ptop_multiplier: 1.0  # Multiplies ptop
      TioverTe: 1.0         # Ti/Te assumption at the pedestal top

  eped_initializer_beat:
    use_default: false
    eped_initializer_namelist:
      nn_location: $MFEIM_PATH/private_code_mitim/NN_DATA/EPED-NN-SPARC/EPED-NN-MODEL-SPARC.keras
      norm_location: $MFEIM_PATH/private_code_mitim/NN_DATA/EPED-NN-SPARC/EPED-NN-NORMALIZATION-SPARC.txt
      corrections_set:
        Bt: 12.2
        R: 1.85
        a: 0.57
      ptop_multiplier: 1.0
      TioverTe: 1.0

  portals_beat:

    use_default: false

    portals_namelist:

      # If null, it will use the default namelist at: __mitimroot__ / "templates" / "namelist.portals.yaml"
      portals_namelist_location: null

      # ------------------------------------------------------------------------------------------------
      # PORTALS parameters (only those parameters to change the main PORTALS namelist)
      # ------------------------------------------------------------------------------------------------
      portals_parameters:
        solution:
          predicted_roa: [0.35, 0.45, 0.55, 0.65, 0.75, 0.875, 0.9]
          keep_full_model_folder: false
          exploration_ranges:
            ymax: 1.0
            ymin: 4.0
            yminymax_atleast: [null, 4]
        transport:
          options:
            tglf:
              run:
                code_settings: "SAT2astra"
                extraOptions:
                  USE_BPER: true
              keep_files: "none" 
        target:
          options:
            force_zero_particle_flux: true
      
      # Operations to do to mitim_state before passing it to PORTALS
      initialization_parameters:
        thermalize_fast: true
        quasineutrality: true

      # If the width of the pedestal has changed, modify the BC for PORTALS accordingly
      change_last_radial_call: true

      # Later beats to utilize past beats surrogate data if available
      use_previous_surrogate_data: true

      # 
      try_flux_match_only_for_first_point: true

    # Operations that will be included as part of the profiles_postprocessing_fun 
    transport_preprocessing:
      lumpImpurities: true
      enforce_same_density_gradients: true

  portals_soft_beat:
    use_default: true

  transp_beat:
    use_default: true

  transp_soft_beat:
    use_default: true